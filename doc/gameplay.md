---
title: 麻雀プログラム ゲーム進行仕様
---

セットアップ仕様を先に読むこと。

## ゲーム進行

東風の例：

1. 東一局：西家和了
2. 東二局：東家和了
3. 東二局一本場：北家九種九牌
4. 東二局二本場：通常流局
5. 東三局二本場：南家和了
6. 東四局（オーラス）：東家和了
7. 東四局一本場（オーラス）：北家トビ

## 一局の進行

事前条件：

* 画面上で次が確認できる状態であること
  * 各プレイヤーの座席、持ち点、河（空であること）
  * 供託・積み棒
  * 牌山：割れ目、ドラ表示牌またはドラそのもの、王牌とハイテイの間の隙間、リンシャンが下りている。
  * 自分の手牌

事後条件：誰かがトビになったか、和了した。または流局した。

```python
def mainloop():
    current_player = 東家
    other_players = 南家, 西家, 北家

    try:
        while 牌山:
            牌 = 牌山.pop() # 便宜上こう書く
            捨牌 = 引く(current_player, 牌, ...) # raises 流局
            手牌と河を更新(current_player, 捨牌)
            牌が捨てられた直後(current_player, 捨牌, 立直宣言: bool)
        handle_drawhand(海底流局)
    except 流局:
        handle_drawhand(途中流局)
    finally:
        cleanup_hand()
```

## 牌山

### 海底流局判定

牌山が尽きたら流局であるので、牌山の管理の都合上通常ツモ時にカウンターを仕込むのが楽。

牌山は `list` で表現していて、ツモられたものは `None` でマークしているから

```python
def exhaustive(walls):
    return sum(wall.count(None) for wall in walls) == 136 - 14
```

## プレイヤー

基本的には自家が牌をツモった直後と他家が牌を切る瞬間にコマンド決定の機会がある。

### 切られた瞬間

* 牌が場に切られた直後：切ったプレイヤー以外全員
  * 鳴き：副露部分を除く手牌構成と他家のハイテイでない捨牌
    * ポン：捨牌と同一の牌からなる対子が存在する。
    * 大明槓：捨牌と同一の牌からなる暗刻が存在する。
    * チー：捨牌が数牌で、それに対応する搭子が存在する。
  * 通常ロン：捨牌＋テンパイが和了形であり、かつ役がある。
* 副露の直後
  * 搶槓ロン：他家の加槓の直後に、加槓牌＋テンパイが自家の和了形である。

スレッドは 3 系統ある。

* 判定スレッド
  * `DiscardEvent` を生成して、プレイヤースレッドに共有させる。
  * プレイヤースレッドを 4 つ　`start()` して `join()` する。
    手番とそれ以外とでターゲットルーチンが異なる。
    それ以外スレッドから `responses` を得られるようにしておく。
  * `responses` を吟味する。
    * ロンが成立する場合
    * カンが成立する場合
    * ポンが成立する場合
    * チーが成立する場合
    * 無反応の場合

* 手番プレイヤースレッド
  * プレイヤーがリーチ宣言済みの場合
    * 自動ツモ切りとする。
    * 前巡のリーチ宣言牌が鳴かれているならば捨牌を曲げる。
  * プレイヤーがリーチ宣言済みでない場合
    * プレイヤーが捨牌を指定する。あるいはタイムアウトでツモ切りになる。
  * `DiscardEvent` オブジェクトに属性として牌を代入する。
  * `DiscardEvent` オブジェクトを `set()` してスレッドを終わる。

* その他プレイヤースレッド
  * 手番プレイヤーが牌を切るのを待つ。つまり `wait()` する。
  * ブロック終了後、その牌を `DiscardEvent` の属性として得る。
  * 待っているプレイヤーが反応できるかテストする。
    * 反応不能、またはタイムアウトの場合には `responses` にノーリアクションを書き込んでスレッドを抜ける。
    * キャンセルも含み、反応できる場合には `responses` にその反応と応答時間を書き込んでスレッドを抜ける。

#### 判定スレッド::反応を吟味する

* `responses` がロンを含む場合
  * ロンが一人：通常
  * ロンが二人：ルールによるが、
    * 頭ハネ採用の場合には座席により和了者を確定する。
    * ダブロンありの場合には二人とも和了とする。
      * 座席順に和了情報出力
  * ロンが三人：ルールによるが、
    * トリプルありルールでは三人とも和了とする。
      * 座席順に和了情報出力
    * 三家和採用ルールでは流局とする。
